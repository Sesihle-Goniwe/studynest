<div class="chat-container">
  <header class="chat-header">
    <h2>{{ groupName || 'StudyNest Group Chat' }}</h2>
  </header>

  <!-- Messages -->
  <div class="chat-messages" #chatMessages>
    <div class="message" 
         *ngFor="let msg of messages"
         [ngClass]="msg.userId === currentUserId ? 'own-message' : 'other-message'"
         (contextmenu)="onMessageRightClick($event, msg)">

      <!-- Avatar clickable -->
      <div class="avatar" *ngIf="msg.userId !== currentUserId">
        <img 
          [src]="msg.profileUrl" 
          alt="avatar" 
          (click)="onAvatarClick(msg)">
      </div>

      <!-- Message Bubble -->
      <div class="bubble">
        <span *ngIf="msg.userId !== currentUserId" class="username">
          {{ msg.fullName || 'Unknown' }}
        </span>

        <!-- Text Message -->
        <div *ngIf="!isFileMessage(msg)" class="message-text">
          {{ msg.message }}
        </div>

        <!-- File Message -->
        <div *ngIf="isFileMessage(msg)" class="file-message">
          <div class="file-container">
            <div class="file-info">
              <span class="file-icon">{{ getFileIcon(msg.fileData?.mime_type || '') }}</span>
              <div class="file-details">
                <span class="file-name">{{ msg.fileData?.file_name || 'Unknown File' }}</span>
                <div class="file-meta">
                  <span class="file-size">{{ formatFileSize(msg.fileData?.file_size || 0) }}</span>
                  <button class="view-btn" type="button" (click)="viewMessageFile(msg)">
                    View Pdf
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Optional caption for file messages -->
          <div *ngIf="msg.message && msg.message !== ('ðŸ“Ž ' + msg.fileData?.file_name)" class="file-caption">
            {{ msg.message }}
          </div>
        </div>
        <span class="time">
          {{ msg.createdAt | date:'shortTime' }}
        </span>
      </div>
    </div>
  </div>

  <!-- PDF Viewer Modal -->
  <div *ngIf="showPdfViewer && pdfSrc" class="pdf-viewer-overlay" (click)="closePdfViewer()">
    <div class="pdf-viewer-container" (click)="$event.stopPropagation()">
      <div class="pdf-header">
        <h3>PDF Viewer</h3>
        <button class="close-viewer-btn" (click)="closePdfViewer()">Ã—</button>
      </div>
      <iframe [src]="pdfSrc" width="100%" height="calc(100% - 50px)" frameborder="0"></iframe>
    </div>
  </div>

  <!-- Options Menu -->
  <div #optionsMenu *ngIf="selectedMessage" class="options-menu" 
       [style.top.px]="menuY" [style.left.px]="menuX"
       (click)="$event.stopPropagation()">
    <button *ngIf="isEditable(selectedMessage)" type="button" (click)="editMessage(selectedMessage)">Edit</button>
    <button type="button" (click)="deleteMessage(selectedMessage)">Delete</button>
    <button type="button" (click)="closeOptionsMenu()">Cancel</button>
  </div>

  <!-- Input Section -->
  <div class="chat-input">
    <!-- Plus button for upload -->
    <button type="button" class="upload-btn" (click)="toggleUploadMenu()">
      +
    </button>

    <!-- File input (hidden) -->
    <input type="file" #fileInput style="display:none" (change)="onFileSelected($event)" />

    <input type="text" [(ngModel)]="newMessage" placeholder="Type a message" 
           (keyup.enter)="sendMessage()" />

    <button (click)="sendMessage()">Send</button>

    <!-- Upload options menu -->
    <div *ngIf="showUploadMenu" class="upload-menu">
      <button type="button" (click)="triggerFileInput('image')">Image</button>
      <button type="button" (click)="triggerFileInput('document')">Document</button>
    </div>
  </div>

  <!-- Error -->
  <p *ngIf="errorMessage" class="error-msg">{{ errorMessage }}</p>
</div>